# Docker 存储

docker默认会将数据存放在容器内，这意味

1.  当容器不再存在时，数据不会持久存在，并且如果另一个进程需要数据，则很难从容器中取出数据。
2. 容器数据紧密依赖主机，无法将数据转移到其他地方
3. 写入容器的可写层需要一个存储驱动程序来管理文件系统。存储驱动程序使用Linux内核提供了一个联合文件系统。与使用直接写入主机文件系统的数据卷相比，这种额外的抽取方式降低了性能。

Docker有两种将数据持久化到主机系统的操作：

1. volumes 卷
2. bind mounts 绑定挂载

## 三种挂载类型volumes、bind mounts、tmpfs

**Docker还支持将容器数据在主机内存中存储文件**。这样的文件不会被持久化。如果您在Linux上运行Docker,`tmpfs`挂载用于在主机的系统内存中存储文件。如果您在Windows上运行Docker，则使用命名管道将文件存储在主机的系统内存中。

无论选择哪一种挂载，数据在在容器内看起来都是一样的。被暴露的数据可以是整个容器目录也可以是指定的一个容器内的文件。

volumes, bind mounts, and `tmpfs`的关系

![Types of mounts and where they live on the Docker host](https://docs.docker.com/storage/images/types-of-mounts.webp)

1. 卷（volumes ）被存储在部分主机文件系统，他们被Docker管理(`/var/lib/docker/volumes/` on Linux)，非Docker进程不允许修改这部分系统文件。**卷（volumes ）是将docker内的数据持久化最好的方式。**

2.  绑定挂载（bind mounts）可以被储存在主机系统任何地方，它们甚至可以是重要的系统文件或者目录。非Docker进程和Docker容器都可以修改它们。
3. **tmpfs挂载只被存储在主机系统的内存中，并且从不会写到主机系统的文件系统中**。

| 挂载方式    | 是否持久化   | 是否安全                                 | 使用方式                                  |
| ----------- | ------------ | ---------------------------------------- | ----------------------------------------- |
| volumes     | 是           | 是，非Docker进程不允许修改这部分系统文件 | 通过`-v` or `--volume`，推荐使用`--mount` |
| bind mounts | 是           | 否，非Docker进程和Docker容器都可以修改   | 通过`-v` or `--volume， 推荐使用`--mount  |
| tmpfs       | 否，在内存中 | 否从不会写到主机系统的文件系统中         | 通过`--tmpfs` ，推荐使用`--mount`         |

## Volumes

Volumes被Docker 创建和管理可以通过命令`docker volume create`,也可以也可以在创建容器或服务时由docker创建卷

当建卷时，它存储在Docker主机上的一个目录中。将卷挂载到容器中时，这个目录就是挂载到容器中的目录。这和bind mount尝试很像，区别就是volumes是由Docker创建的并且与主机核心的功能是隔离的。

创建的Volumes可以同时挂载到多个容器中。当没有正在运行的容器使用Volumes时，Volumes依然存在并可用，不会被删除。如果需要删除使用`docker volume prune`

```
# 创建卷
docker volume create
# 删除卷
docker volume prune
```

当挂载一个卷，他可能被命名也可能匿名。匿名卷被赋予一个随机的名称，保证在给定的Docker主机中是唯一的。与命名卷一样，即使删除了使用匿名卷的容器，匿名卷也会持续存在，除非使用--rm命令删除容器，在这种情况下，匿名卷将被销毁。如果你创建了很多容器，每个容器都会有自己的匿名卷，匿名卷不会被重复使用或者在容器之间自动分享。如果需要**在容器之间分享匿名卷，需要使用volume ID**.

**Volumes 也可以使用volume drivers，将数据存储在远程机器或者云主机等**。

## bind mounts

**与Volumes相比bind mounts绑定挂载的功能有限**，当你使用一个bind mount取绑定一个主机上的文件或者目录到容器上。这个文件或者目录在主机上的全路径被引用。这个文件或者目录也不需要存在，如果不存在的话会自动用创建命令创建。Bind mounts 是很快的，但是它们依赖于具有特定目录结构的主机文件系统。如果您正在开发新的Docker应用程序，请考虑使用命名卷。不能使用Docker CLI命令直接管理绑定挂载。

### 为什么不推荐

默认情况下，绑定挂载允许对主机上的文件进行写访问。

使用绑定挂载的一个副作用是，您可以通过在容器中运行的进程来更改主机文件系统，包括创建、修改或删除重要的系统文件或目录。这是一个强大的功能，可能会有安全隐患，包括影响主机系统上的非docker进程。

### 小贴士

使用大型存储库或单节点，或者使用不再随代码库扩展的虚拟文件系统?查看已同步的文件共享。它通过使用同步文件系统缓存来增强绑定挂载性能，从而提供快速灵活的主机到vm文件共享。

## tmpfs

无论是在容器还是主机，使用 `tmpfs` mount 方式数据都不会被持久化。在容器的生命周期内，容器可以使用它来存储非持久状态或敏感信息。例如，在内部，Swarm服务使用tmpfs挂载将秘密挂载到服务的容器中。

## 命名管道

Named pipes 可以让docker主机和容器之间沟通。常见的用例是在容器内部运行第三方工具，并使用命名管道连接到Docker引擎API。